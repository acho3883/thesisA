-- List with all user profiles when conditions met --
SELECT DISTINCT	core_user_profiles.user_id,
		core_team_members.team_id,
		core_programs.name AS program_name, 
		core_institutions.name AS institution_name,
		core_experiences.name AS experience_name
	
FROM 	core_user_profiles,
	core_team_members, core_teams, core_programs, core_institutions, core_experiences
	
WHERE core_user_profiles.user_id IN
(
-- Eliminate non-existing users --
SELECT user_id
FROM core_user_action_logs

-- Eliminate users with multiple teams --
INTERSECT
SELECT user_id
FROM core_team_members
GROUP BY user_id
HAVING count(*) = 1

-- Eliminate admins --
except
SELECT      user_id
FROM        core_user_action_logs
WHERE       uri LIKE '%admin%'
)

-- Match profiles --
AND
core_team_members.user_id = core_user_profiles.user_id
AND
-- Match teams --
core_team_members.team_id = core_teams.id
AND
-- Match programs --
core_teams.program_id = core_programs.id
AND
-- Match institutions --
core_institutions.id = core_programs.institution_id
AND
-- Match experiences --
core_experiences.id = core_user_profiles.current_experience_id

ORDER BY core_team_members.team_id, core_user_profiles.user_id
